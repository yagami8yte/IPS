<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Forte Checkout v2 Credentials Test</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            box-sizing: border-box;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        #console-output {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>üîê Forte Checkout v2 Credentials Test</h1>

    <div class="test-section">
        <h2>Enter Your Forte Sandbox Credentials</h2>
        <label>API Access ID:</label>
        <input type="text" id="apiAccessId" value="03a04fee3e438b44ef168052227cf9ac">

        <label>API Secure Key:</label>
        <input type="password" id="apiSecureKey" value="c24eadad0838c40a8bb469c67d71eceb">

        <label>Location ID:</label>
        <input type="text" id="locationId" value="411494">

        <label>Test Amount ($):</label>
        <input type="number" id="testAmount" value="1.00" step="0.01">

        <button onclick="testCredentials()">üß™ Test Credentials</button>
    </div>

    <div id="result"></div>

    <!-- Hidden Forte Checkout button -->
    <a href="#" id="forte-checkout-button" style="display: none;">Pay</a>

    <!-- Console output -->
    <div id="console-output"></div>

    <script>
        // Console logging
        const consoleDiv = document.getElementById('console-output');
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : '#0ff';
            consoleDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(message);
        }

        // Capture console output
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        console.log = function(...args) {
            log(args.join(' '), 'info');
            originalConsoleLog.apply(console, args);
        };
        console.error = function(...args) {
            log('ERROR: ' + args.join(' '), 'error');
            originalConsoleError.apply(console, args);
        };

        // Calculate HMAC-SHA256 signature
        async function calculateSignature(apiAccessId, method, versionNumber, totalAmount, utcTime, orderNumber, apiSecureKey) {
            const signatureString = `${apiAccessId}|${method}|${versionNumber}|${totalAmount}|${utcTime}|${orderNumber}||`;

            log(`Signature string: ${signatureString}`);

            // Convert key and message to Uint8Array
            const encoder = new TextEncoder();
            const keyData = encoder.encode(apiSecureKey);
            const messageData = encoder.encode(signatureString);

            // Import key
            const key = await crypto.subtle.importKey(
                'raw',
                keyData,
                { name: 'HMAC', hash: 'SHA-256' },
                false,
                ['sign']
            );

            // Calculate signature
            const signature = await crypto.subtle.sign('HMAC', key, messageData);

            // Convert to hex string
            const hashArray = Array.from(new Uint8Array(signature));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

            log(`Generated signature: ${hashHex}`);
            return hashHex;
        }

        // Load Forte script dynamically
        function loadForteScript() {
            return new Promise((resolve, reject) => {
                if (document.getElementById('forte-script')) {
                    resolve();
                    return;
                }

                log('Loading Forte Checkout v2 script...');
                const script = document.createElement('script');
                script.id = 'forte-script';
                script.src = 'https://sandbox.forte.net/checkout/v2/js';
                script.onload = () => {
                    log('‚úÖ Forte script loaded successfully', 'success');
                    resolve();
                };
                script.onerror = () => {
                    log('‚ùå Failed to load Forte script', 'error');
                    reject(new Error('Failed to load Forte script'));
                };
                document.head.appendChild(script);
            });
        }

        async function testCredentials() {
            const resultDiv = document.getElementById('result');
            consoleDiv.innerHTML = '';
            resultDiv.innerHTML = '';

            const apiAccessId = document.getElementById('apiAccessId').value;
            const apiSecureKey = document.getElementById('apiSecureKey').value;
            const locationId = document.getElementById('locationId').value;
            const testAmount = parseFloat(document.getElementById('testAmount').value).toFixed(2);

            log('========================================');
            log('üß™ Testing Forte Checkout v2 Credentials');
            log('========================================');
            log(`API Access ID: ${apiAccessId}`);
            log(`Location ID: ${locationId}`);
            log(`Test Amount: $${testAmount}`);

            try {
                // Load Forte script first
                await loadForteScript();
                // Generate UTC time in .NET Ticks format
                const now = new Date();
                // .NET ticks = (Unix milliseconds * 10000) + 621355968000000000
                const utcTime = (now.getTime() * 10000 + 621355968000000000).toString();
                log(`UTC Time (Ticks): ${utcTime}`);

                const orderNumber = 'TEST-' + Math.floor(Math.random() * 1000);
                log(`Order Number: ${orderNumber}`);

                // Calculate signature
                const signature = await calculateSignature(
                    apiAccessId,
                    'sale',
                    '2.0',
                    testAmount,
                    utcTime,
                    orderNumber,
                    apiSecureKey
                );

                // Update button attributes
                const button = document.getElementById('forte-checkout-button');
                button.setAttribute('api_access_id', apiAccessId);
                button.setAttribute('method', 'sale');
                button.setAttribute('version_number', '2.0');
                button.setAttribute('location_id', locationId);
                button.setAttribute('total_amount', testAmount);
                button.setAttribute('utc_time', utcTime);
                button.setAttribute('order_number', orderNumber);
                button.setAttribute('signature', signature);
                button.setAttribute('embedded', 'false');

                log('Button attributes set successfully');
                log('Triggering Forte Checkout...');

                // Set up event listeners BEFORE clicking
                window.addEventListener('message', function(event) {
                    log(`Message received: ${JSON.stringify(event.data)}`);
                }, false);

                // Add Forte event listeners if available
                if (window.forte_checkout_events) {
                    window.forte_checkout_events.addEventListener('error', function(e) {
                        log('‚ùå FORTE ERROR EVENT: ' + JSON.stringify(e.detail), 'error');
                        resultDiv.innerHTML = `
                            <div class="result error">
                                ‚ùå CREDENTIALS INVALID<br>
                                Error: ${e.detail.message || 'Authentication failed'}<br>
                                <small>Your API Access ID, API Secure Key, or Location ID is incorrect.</small>
                            </div>
                        `;
                    });

                    window.forte_checkout_events.addEventListener('ready', function(e) {
                        log('‚úÖ FORTE READY EVENT: Checkout loaded successfully', 'success');
                        resultDiv.innerHTML = `
                            <div class="result success">
                                ‚úÖ CREDENTIALS VALID!<br>
                                <small>Your Forte Checkout credentials are correct.</small>
                            </div>
                        `;
                    });
                }

                // Wait a bit for Forte to initialize, then click
                setTimeout(() => {
                    log('Clicking button...');
                    button.click();

                    // If no response after 5 seconds, check manually
                    setTimeout(() => {
                        if (!resultDiv.innerHTML) {
                            resultDiv.innerHTML = `
                                <div class="result info">
                                    ‚è≥ Waiting for Forte response...<br>
                                    <small>Check the console output above for details. If you see "Invalid authentication", your credentials are wrong.</small>
                                </div>
                            `;
                        }
                    }, 5000);
                }, 2000);

            } catch (error) {
                log('Exception: ' + error.message, 'error');
                resultDiv.innerHTML = `
                    <div class="result error">
                        ‚ùå ERROR<br>
                        ${error.message}
                    </div>
                `;
            }
        }

        log('Test page loaded. Enter your credentials and click "Test Credentials".');
    </script>
</body>
</html>
